<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Joey Rucska - Data Science Projects</title>
<style>
    body {
        font-family: Tahoma, Arial, sans-serif;
        margin: auto;
    }

    .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 10px;
    }

    select, button {
        padding: 8px;
        font-size: 1rem;
    }

    .plots-wrapper {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
    }

    .plot-container {
        text-align: center;
        flex: 1 1 400px;
    }
        .plot-container h3 {
        margin-bottom: 0.5em;
      }

    ul li {
            margin-bottom: 0.25lh; /* Adjust the value as needed */
    }

    ul {
            line-height: 1.5; /* Adjust the value for more or less space */
    }

    img {
        max-width: 100%;
        height: auto;
        border: 1px solid #ddd;
        padding: 6px;
        margin-top: 10px;
    }

    @media (max-width: 850px) {
    .plots-wrapper { flex-direction: column; }
    }

    /* Style the header */
    .header {
        padding: 40px;
        text-align: center;
        background: #ca672e;
        color: white;
        border-bottom: solid black;
        font-family:  Georgia, serif;
    }

        /* Increase the font size of the h1 element */
        .header h1 {
            font-size: 34px;
        }

        /* Set the font size of the p element */
        .header p {
            font-size: 26px;
        }

        .top-link {
            text-decoration: none; /* removes default styling of the link. Underline etc.) */
            background-color: rgba(86, 86, 86, 0.625); /* obvious */
            color: white; /* text color */
            margin: 1rem; /* adding 1rem of space around the button in all directions */
            padding: 0.5rem 1rem; /* Adding space between the text and the border (first value is top and bottom. Second value is right and left) */
            border-radius: 0.5rem; /* rounding the edges */
            font-family: Tahoma, Arial, sans-serif;
            font-size: 22px;
            border: solid rgba(220, 220, 220, 0.625);
        }

        .top-link:hover {
            color: black; /* text color */
            background-color: rgba(220, 220, 220, 0.625); /* obvious */
            border: solid rgba(86, 86, 86, 0.625);
        }


    /* Main column */
    .main {
            flex: 60%; /* Set the width of the main content */
            background-color: white; /* White background color */
            padding-top: 40px;
            padding-left: 25%;
            padding-right: 25%;
            line-height: 1.5;
        }

            /* Increase the font size of the h1 element */
            .main h1 {
                padding-top: 16px;
                font-size: 20px;
                font-weight: bold;
                text-decoration: underline;
            }

    /* plots column */
    .plots {
            flex: 80%; /* Set the width of the main content */
            background-color: white; /* White background color */
            padding-left: 20%;
            padding-right: 20%;
            line-height: 1.5;
        }

    /* For mobile: reduce padding */
    @media (max-width: 768px) {
        .main {
            padding-left: 40px;
            padding-right: 40px;
        }
        .plots {
            padding-left: 40px;
            padding-right: 40px;
        }
    }

    #analysis-description {
        background: #f8f8f8;
        padding: 10px 14px;
        border-left: 5px solid #3366cc;
        border-radius: 4px;
        margin-bottom: 15px;
    }

    .dropdown-block {
        display: inline-block;
        margin-right: 15px;
    }

    .dropdown-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 3px;
        text-align: left;
    }

</style>
</head>
<body>

<div class="header">
    <h1>Identifying influential conditions on shot outcomes in the NHL</h1>
    <p>Joey Rucska</p>
    <p style="margin-bottom: 3rem;">Last updated on December 19, 2025.</p>
    <a href="https://github.com/rucskajj/Data-Science-Projects/tree/main/NHL/xG" class="top-link">Github</a>
</div>



<div class="main">

  <b>This analysis attempts to identify which conditions have a substantial impact on shot outcomes (goal/no goal) in the National Hockey League (NHL).</b> Presumably, there are a multitude of conditions or factors with a measureable influence: shot location, shot type (e.g. slapshot, wrist shot, etc.), whether the shot came off a rebound or not, etc. Here, I develop a quantitative and graphical exploration of a data set representing hundreds of thousands of NHL shots, and the influence of various conditions on shot outcomes. <br><br>

  Identifying the strongest factors can help inform the development of so-called expected goals (xG) models, which predict the likelihood any given shot attempt results in a goal. I present my own expected goals models on a separate page, <a href="https://rucskajj.github.io/Data-Science-Projects/NHL/xG-ratios/xG-ratios.html">here</a>.<br><br>
  
  The Python code used for this analysis is available on my <a href="https://github.com/rucskajj/Data-Science-Projects/tree/main/NHL/xG">GitHub</a>. <br>
  <hr>
  <h1>Data & Methods</h1>
  The dataset for this project comes from <a href="https://moneypuck.com/data.htm">MoneyPuck</a>. They provide CSV files with a record of (presumably) every shot attempt event in a given NHL season. Ultimately, this data comes from the NHL itself, though the authors at MoneyPuck have made some additions, including an adjustment for arena-by-arena biases that are known and documented in the hockey analytics community. It is worth noting that these data are collected manually, by shot trackers present at each game, staffed by the NHL. Thus, classifying a shot as a wrist shot or snap shot, for example, comes from an individual's subjective interpretation of that event, which of course will impart some noise/variability in the league-wide data set. That said, these data sets are the most comprehensive, publicly available data sets on hockey shots, and they are widely used in the analytics community.<br><br>
  
  It is worth noting that the NHL has recently developed an advanced system for tracking player & puck positions digitally, in real time. To my understanding, these data sets are only available internally,for analytics departments within NHL clubs. This system could provide additional data such as shot speed, vertical shot location, spatial proximity to opposing players, proximity in time to recent passes, etc., all which are not available in the MoneyPuck data sets but would undoubtedly have a strong influence on shot outcomes. In short, more robust xG models will most certainly be available in the future, if they aren't already, internally. The framework I provide for the development of my model&mdash;starting here, with an overview of the impact of each condition&mdash;should be adaptable to a more expansive data set.<br><br>
  
  There are approx. 100,000 shot "events" in each season of MoneyPuck data. This exploratory analysis is built on data from all seasons inclusive of 2015-2024. Each shot/event/record (I use these terms interchangeably, most often as "shot attempt" or SAT) comes with dozens of attributes or conditions, including "x" and "y" co-ordinates of the events, identity of the shooter, the goalie, number of attacking forwards on the ice---the list goes on, and on. Notably, the <b>outcome</b> of the shot attempt is available, with three options: a shot on goal (SOG; the goalie saved the shot); a miss (shot did not hit the net, or hit the post); or a goal. (One notable outcome is omitted: a shot block. To match existing language in hockey analytics, this makes the records in this analysis not "shot attempts", but "unblocked shot attempts". "Block" outcomes are not a part of the MP data, but an xG model would likely benefit from its inclusion, if possible.)<br><br>
  
  On this page, I attempt to identify which attributes or conditions have a strong influence on whether any given attempt results in a goal. These attributes can then (later) be built into an expected goal model, which predicts the likelihood any given shot attempt results in a goal.<br><br>

  <b>All of my analysis is ultimately derived from 2D histograms of the location of the shots/events.</b> Presumably, shot location is one of, if not the most important factor in determining a shot outcome, which is why my analysis starts here. The influence of all other conditions (shot type, 5v5 vs. 5v4, etc.) or factors will be measured according to their influence on histograms in this 2D space.  One axis is mapped to the straight-line (i.e. "radial") distance from the event to the net, and while the other axis maps the angle the shot location makes w.r.t. the length-wise centre line of the ice. <br><br>

  Below, different plots/histograms for different "conditions" can be accessed via the drop-down menus. Pick which condtion you want to explore (e.g. "Shot Type"), then pick a value for that condition (e.g. "Wrist Shot"), and finally pick the event outcome (e.g. "Goals". "Shot Attempts" displays all events). The plots will automatically update to reflect your choices. Detailed descriptions of my plots are described as follows:<br><br>

  <b>Event Map & Histogram</b>
  <ul>
      <li>Top panel: the distribution of events in the offensive zone. Shown in dashed lines are the bins used for the histogram.</li>
      <li>Bottom panel: A 2D histogram in distance-angle space. Regions outside the solid black lines denotes bins that are outside physical boundaries of the rink; no events are recorded for those bins. (Note: "negative" and "positive" angles are not recorded individually, the shot outcome behaviour is quite symmetric about the length-wise centre line. See Analysis "1" discussion for more details.)</li>
  </ul>

  <b>Expected Goals Histogram</b>
  <ul>
      <li>Greyscale plot: A histogram of "expected goals" (xG), which, for this page, simply represents the fraction of shot attempts that results in goals. This histogram is exactly equal to the goals histogram divided by the shot attempts histogram.</li>
      <li>Blue-red plot: A histogram of what I call ΔxG, which is exactly equal to the xG histogram for this condition-value pair subtracted by the xG histogram for the reference data set. Note: ΔxG is only calculated in bins with more than 20 shot attempts.</li>
  </ul>
  
  <b>Impact of Conditions</b>
  <ul>
      <li>A plot of two metrics which quantify how the data set for all applicable condition-value pairs (the subsets) differs from the reference data set.</li>
      <li>y-axis: the difference in overall shooting percentage (S%) for the subset and the reference data set. S% = total number of goals / total number of shot attempts.</li>
      <li>x-axis: the sum of the ΔxG histogram for the condition-value pair, where each ΔxG value is weighted by the number of shot attempts in that bin.</li>
      <li>Note: the numerical values for these data are printed within the ΔxG histogram. "wΔxG" is the x-axis value, "diffS%" is the y-axis value.</li>
  </ul>


  <h1>Results & Interpretation</h1>

  As mentioned above, the main technique in this analysis compares a subset of data, based on a specific shot condition, to a "reference" data set. I present a few unique "analyses" which use different reference datasets in order to emphasize the effects on individual conditions. The different analyses can be selected from the first drop-down menu below. Analysis "1" takes a broad look at a list of conditions, while analyses "2" and "3" focus on specific conditions of interest. <br><br>

  <b>General thoughts on interpreting the plots:</b>
  <ul>
      <li>ΔxG histogram: red values mean shots from that distance-angle location were more likely to result in a goal for the chosen subset, when compared to the reference. Blue values mean shots were less likely to go in.</li>
      <li>Impact of Conditions, y-axis: values above zero mean that, regardless of shot location (i.e. on average), shot events under these conditions are more likely to result in goals when compared to the reference data set.</li>
      <li>Impact of Conditions, x-axis: values above zero means that, when the shot location is taken into account, these conditions are more likely to result in goals than shot attempts in the reference set.</li>
  </ul>
  <br>

  <!-- Dropdown menus -->
  <div class="controls">
    <label for="analysis-select"><b>Analysis:</b></label>
    <select id="analysis-select"></select>
    </div>

    <div id="analysis-description">
        <!-- Analysis description will appear here -->
    </div>

    <!-- Condition, Value, Event Dropdowns + Contours-Hists Download Button -->
    <div class="controls">
        <div class="dropdown-block">
            <div class="dropdown-title" id="condition-title">Condition</div>
            <select id="condition-select"></select>
        </div>

        <div class="dropdown-block">
            <div class="dropdown-title" id="value-title">Value</div>
            <select id="value-select"></select>
        </div>

        <div class="dropdown-block">
            <div class="dropdown-title" id="event-title">Event</div>
            <select id="event-select"></select>
        </div>
    </div>

  <!-- Toggle Buttons -->
  <div class="controls">
    <p style="font-size: 18px; margin-top: 0.5em; margin-bottom: 0.5em;">Toggle show/hide for each plot:</p>
    <button id="toggle-contours" type="button">Event Map</button>
    <button id="toggle-2d" type="button">xG Histogram</button>
    <button id="toggle-cond" type="button">Impact of Conditions</button>
  </div>
</div>

<div class="plots">
    <!-- Plots wrapper -->
    <div class="plots-wrapper">

    <!-- Event Map & Histogram Plot -->
    <div class="plot-container" id="contours-container">
        <h3>Event Map & Histogram</h3>
        <img id="hist-img" src="" alt="Event Map & Histogram">
        <div class="controls" style="justify-content:center; margin-top:10px;">
            <button id="download-btn" type="button">Download Event Map</button>
        </div>
    </div>

    <!-- Expected Goals Histogram Plot -->
    <div class="plot-container" id="hist2d-container">
        <h3>Expected Goals Histogram</h3>
        <img id="hist2d-img" src="" alt="Expected Goals Histogram">
        <div class="controls" style="justify-content:center; margin-top:10px;">
            <button id="download2d-btn" type="button">Download xG Histogram</button>
        </div>
    </div>

    <div class="plot-container" id="cond-container">
        <h3>Impact of Conditions</h3>
        <img id="cond-img" src="" alt="Conditions plot">
        <div class="controls" style="justify-content:center; margin-top:10px;">
            <button id="downloadcond-btn" type="button">Download Impact of Conditions</button>
        </div>
    </div>

    </div>

</div>

<script>

/* ---- Human-readable labels ---- */
const conditionLabels = {
  PlayingStrength: "Even/Special Teams",
  anglesign: "Shot Angle",
  bForwardPlayer: "Forward Shooter",
  bOffWing: "Off-Wing Shot",
  bPlayoffs: "Playoff Game",
  bReb: "Rebound Shot",
  type: "Shot Type"
};

const valueLabels = {
  "Neg": "Right",
  "Pos": "Left",
  "1": "Yes",
  "0": "No",
  "3v3": "3v3",
  "4v4": "4v4",
  "4v5": "4v5 (PK)",
  "5v3": "5v3 (PP)",
  "5v4": "5v4 (PP)",
  "5v5": "5v5",
  "6v5": "6v5",
  BACK: "Backhand",
  DEFL: "Deflection",
  SLAP: "Slap Shot",
  SNAP: "Snap Shot",
  TIP: "Tip-In",
  WRAP: "Wraparound",
  WRIST: "Wrist Shot"
};

const eventLabels = {
  SAT: "Shot Attempts",
  SOG: "Shots on Goal",
  goal: "Goals",
  miss: "Missed Shots"
};

const analysisLabels = {
    "A1": "1: Exploring all conditions",
    "A2": "2: Shot type",
    "A3": "3: Even vs. Special Teams"
};


/* ---- Descriptions for each analysis ---- */
const analysisDescriptions = {
  "A1": `
    <strong>Reference data:</strong> the full data set; i.e. all SAT events regardless of condition. <br><br>

    Starting with the Impact of Conditions plot, four conditions stand out as having a strong influence on shot outcomes: whether the shot came from a rebound, whether the shot was taken by forward or defence, shot type (wrist, slap, deflection, etc.), and balance of skaters on the ice (5v5, 5v4, etc.). A number of these condition-value pairs deviate strongly from the origin, suggesting their shot outcome behaviour is the most different from the full data set catalogue of events. In Analysis 2 & 3, respectively, I explore shot type & even vs. special teams in more detail. The other condition-value pairs clump closely to the origin, and need to be investigated individually, using the histograms.<br><br>

    My thoughts on each condition are as follows:
    <ul>
      <li><b>Rebounds:</b> perhaps the strongest factor on shot outcome outside of shot location. The overall S% for rebounds is 16.8%, compared to 6.6% in the full data set.</li>
      <li><b>Shot type:</b> there are plenty of interesting patterns here, worthy of their own exploration, which I dive into in Analysis 2.</li>
      <li><b>Even/Special Teams:</b> another important factor, which, like shot type, I explore on its own in Analysis 3.</li>
      <li><b>Off-Wing Shots:</b> oddly, in both value options (off-wing or strong side), the distribution of shots are not symmetric about the length-wise centre line, which is not what I would expect, for a data set with over 1 million entries. I suspect there are some inconsistencies in how this attribute is recorded by the shot trackers. I plan to ignore this attribute in my expected goals model.</li>
      <li><b>Forward vs Defence:</b> as one expects, defencemen primarily take shots far away from the net, as is immediately apparent in the Event Map plots. It should be no surprise, then, that the overall defencemen shooting percentage (3.4%) is lower than the forward percentage (8.0%). One may be tempted to assume that defencemen, overall, are less capable shooters than offense-minded forwards, and that this, too contributes to the difference in shooting percentage. However, in my opinion, this is not supported by the data. In the Impact of Conditions plot, both "bForward" conditions lie close to the vertical zero line, which means that when shot location is taken into account, defencemen and forwards score at fairly similar rates. The ΔxG histogram shows forwards are more proficient at scoring from the corner and sideboards.</li>
      <li><b>Playoff vs Regular Season:</b> there appears to be little difference in shot outcome behaviour for playoffs vs. regular season games, which I did not anticipate. By eye, playoff games appear to be much "tighter", with more effort put into intensive defensive play. The ΔxG histogram shows that in the playoffs it may be slightly more difficult to get goals from the mid-slot, but this is not a strong effect.</li>
      <li><b>Shot angle:</b> this attribute may have the weakest effect on shot outcomes. There seems to be very little variation in overall shooting percentage or the distribution of xG in the histograms. This is to be expected in a league-wide data set like this. In terms of the rules, hockey is symmetric about the length-wise centre line. On average, over many games, one should expect the game to play out symmetrically about this line. Certainly, individual teams may break this symmetry by preferring to develop plays towards an offensive specialist who typically plays on one side of the ice. I would expect a team-specific analysis, or an analysis on individual players&mdash;goalies or skaters&mdash;to require close attention to shot angle. For my goals in developing a league-wide xG model, I believe I can (and should) ignore this attribute.</li>
    </ul>
  `,
  "A2": `
    <strong>Reference data:</strong> all non-rebound, 5v5 events, for all shot types. <br><br>

    Here, I want to explore how the different shot types affect shot outcomes. As seen in Analysis "1", rebounds and even strength vs. special teams conditions have a strong influence on outcomes. To remove their influence, the reference data set for this analysis only explores non-rebound, 5v5 events.<br><br>

    A detailed understanding of the Impact of Conditions plot will help here. Along the y-axis, conditions in the top portion (S% difference > 0) result in a higher overall shooting percentage than the reference, while the opposite is true for shots in the lower portion. The x-axis requires more work to interpret. Directly, this number is a sum of the ΔxG histogram multiplied (i.e. weighted) by the shot attempts histogram for that bin. So, conditions in the right portion (weighted ΔxG > 0) indicate that, when shot location is taken into account, these kinds of shots are more likely to result in goals than shots of any type (i.e. shots from the reference data set). For the left portion of the plots, these conditions are less likely to produce goals&mdash;given the choice, shooters would be better to use a different kind of shot based on the locations those types of shots were taken from.<br><br>

    My specific thoughts on the influence of each individual shot type are as follows:
    <ul>
      <li><b>Wrist shot:</b> these shots are particularly dangerous from close-in, but less so the farther away the shot is from the net.</li>
      <li><b>Snap shot:</b> this shot type is in the upper-right quadrant of the Impact plot, signifying it is particularly effective at producing goals. The ΔxG histogram is nearly entirely red, which supports the conclusion that the snap shot is dangerous from anywhere. Note: it is not clear how the shot trackers differentiate snap shots from wrist shots.</li>
      <li><b>Deflection & Tip-In:</b> these shot types lie close together in the Impact plot and have similar ΔxG histograms, and thus I believe are susceptible to the same interpretation. While producing a higher overall S% when considering all (5v5, non-rebound) shots, tip-ins and deflections primarily occur in the low-slot (close to the net, centre of the ice), where local shooting percentages are high. The data suggests shooters would be better to take a snap shot or wrist shot from these locations, but this is a moot point, since that choice is not usually available. Tips/deflections plays are secondary shots developed from, typically, a primary shot that starts from the perimeter of the offensive zone. However, I would like to point out a region of high ΔxG at low angles and large distances, which tells us deflections/tips from the high-slot are notably effective at producing goals.</li>
      <li><b>Slap Shot:</b> this shot type exists in a unique part of this parameter space, being relatively deep in the bottom-right quadrant of the Impact plot. These shots (S% = 3.5%) are, overall, less likely to result in a goal than any other shot type, even wraparounds. However, being in the right half of this plot, they are the best choice of shot at the locations they are taken from. In the shot attempts Event Map plots, unsurprisingly, slap shots primarily come from close to the blue line, where local shooting percentages are low.</li>
      <li><b>Backhand:</b> the backhand trends in the same direction as the Deflection & Tip-Ins. Given the chance, it would be better to attempt a snap shot, for example, than a take a backhand shot. Of course, this is an obvious insight. Even recreational hockey players understand backhands are less dangerous. Typically, though, the defensive pressure surrounding a backhand shot prohibited the shooter from moving the puck to their forehand.</li>
      <li><b>Wraparound:</b> being in the bottom-left quadrant of the Impact plot, this shot type is not very effective at producing goals. Its ΔxG histogram is entirely blue. The wraparound is a highly situational shot. Maintaining possession in the hopes of generating a better scoring chance may be a better strategy than attempting a wraparound in most cases.</li>
    </ul>
  `,
  "A3": `
    <strong>Reference data:</strong> all non-rebound events at 5v5. <br><br>

    Here, I want to explore how the different conditions for the number of players on the ice (5v4-power play, 4v5-short handed, etc.) affects shot outcomes. As seen in Analysis "1", rebounds and even strength vs. special teams conditions have a strong influence on outcomes. My reference data set for this analysis is all non-rebound, 5v5 events. Thus, unlike my other analyses, the "subset" datasets are not within the reference data set itself. In this analysis, I am comparing distinct, separate data sets.<br><br>

    I explore just five playing strength conditions: 5v4, 4v5, 4v4, 3v3, and 5v3. There were other scenarios in this dataset, but they are more rare, and featured fewer shot attempts, which I feared would lead to noisy, distracting statistics. I focus instead on more common scenarios.<br><br>

    In my opinion, there are fewer insights to glean from this analysis than the others. All five conditions lie in the upper-right quadrant of the Impact of Conditions plot, indicating that shots taken in each of these situations are 1) overall more likely to result in goals than 5v5 shots, and 2) when shot location is taken into account, shots in these conditions are also more likely to result in goals than 5v5 shots from the same locations. This is not a surprising result for the powerplay scenarios (5v4 and 5v3), as the offensive has an enhanced ability to set-up high-danger shot chances compared to 5v5. From Analysis 1, the 5v3 condition has the strongest influence on producing goals goals than an other condition, besides rebounds. This is also not surprising for the 4v4 or 3v3 scenarios, as the greater amount of space on the ice with fewer players can plausibly lead to a higher proportion of goals per shot.<br><br>
    
    It is surprising that this trend applies to the shorthanded 4v5 condition as well. One would expect that the defensive team (5 players) would have an advantage in smothering offensive chances in this scenario. Perhaps a better interpretation is that, when shorthanded, teams only attempt low-risk, high-reward (4 player) offense&mdash;when defensive-zone a blocked shot leading to an odd-player rush, for example&mdash;and otherwise avoid attempting offensive possession, and conservatively clear the puck from their defensive zone without attempting low-chance shots which could lead to turnovers and odd-player rushes against.<br>
  `
};

/* ---- DOM elements ---- */
const analysisSel = document.getElementById("analysis-select");
const condSel = document.getElementById("condition-select");
const valSel = document.getElementById("value-select");
const evtSel = document.getElementById("event-select");
const img = document.getElementById("hist-img");
const img2d = document.getElementById("hist2d-img");
const imgCond = document.getElementById("cond-img");
const downloadBtn = document.getElementById("download-btn");
const download2dBtn = document.getElementById("download2d-btn");
const downloadCondBtn = document.getElementById("downloadcond-btn");
const contoursContainer = document.getElementById("contours-container");
const hist2dContainer = document.getElementById("hist2d-container");
const condContainer = document.getElementById("cond-container");
const toggleContoursBtn = document.getElementById("toggle-contours");
const toggle2dBtn = document.getElementById("toggle-2d");
const toggleCondBtn = document.getElementById("toggle-cond");

/* ---- Reference dataset ---- */
const referenceLabel = "ref";

/* ---- Load file map ---- */
let fileMap = {}; 

fetch("analyses_filemap.json")
  .then(response => response.json())
  .then(data => {
    fileMap = data;

    Object.keys(fileMap).forEach(a => {
        analysisSel.add(new Option(analysisLabels[a] || a, a));
    });

    updateConditionDropdown();
    updateAnalysisDescription();
  });

/* ---- Helper functions ---- */
function getAvailableConditions(analysisFiles) {
  const conds = new Set();
  analysisFiles.forEach(f => {
    const parts = f.split("-");
    if (parts[0] !== "ref") conds.add(parts[0]);
  });
  return Array.from(conds);
}

function getAvailableValues(cond, analysisFiles) {
  const values = new Set();
  analysisFiles.forEach(f => {
    const parts = f.split("-");
    if (parts[0] === cond) values.add(parts[1]);
  });
  return Array.from(values);
}

function getAvailableEvents(cond, val, analysisFiles) {
  const evts = new Set();
  analysisFiles.forEach(f => {
    const parts = f.split("-");
    if (cond === referenceLabel) {
      if (f.startsWith("ref-")) evts.add(parts[1].replace(".png",""));
    } else if (parts[0] === cond && parts[1] === val) {
      evts.add(parts[2].replace(".png",""));
    }
  });
  return Array.from(evts);
}

/* ---- Update Dropdowns ---- */
function updateConditionDropdown() {
    condSel.innerHTML = "";

    const analysisFiles = fileMap[analysisSel.value];
    condSel.add(new Option("Reference Data", referenceLabel));
    const conds = getAvailableConditions(analysisFiles);
    conds.forEach(c => condSel.add(new Option(conditionLabels[c] || c, c)));

    updateValueDropdown();
}

function updateValueDropdown() {
    const cond = condSel.value;
    const analysisFiles = fileMap[analysisSel.value];
    const valueTitle = document.getElementById("value-title");

    if (cond === referenceLabel) {
        // Hide the value dropdown and its title for reference data
        valSel.style.display = "none";
        valueTitle.style.display = "none";
    } else {
        // Show the value dropdown and its title for normal conditions
        valSel.style.display = "inline-block";
        valueTitle.style.display = "block";

        // Populate values normally
        valSel.innerHTML = "";
        const values = getAvailableValues(cond, analysisFiles);
        values.forEach(v => valSel.add(new Option(valueLabels[v] || v, v)));
    }

    updateEventDropdown();
}


function updateEventDropdown() {
  evtSel.innerHTML = "";
  const cond = condSel.value;
  const analysisFiles = fileMap[analysisSel.value];

  // Desired fixed order:
  const eventOrder = ["SAT", "SOG", "miss", "goal"];

  // Determine which events are available
  let evts = [];
  if (cond === referenceLabel) {
    evts = getAvailableEvents(referenceLabel, null, analysisFiles);
  } else {
    const val = valSel.value;
    evts = getAvailableEvents(cond, val, analysisFiles);
  }

  // Sort according to our fixed ordering
  evts.sort((a, b) => eventOrder.indexOf(a) - eventOrder.indexOf(b));

  // Populate dropdown in consistent order
  evts.forEach(e => evtSel.add(new Option(eventLabels[e] || e, e)));

  updateImages();
}

/* ---- Update images ---- */
function updateImages() {
  const cond = condSel.value;
  const evt = evtSel.value;
  const analysisFolder = `plots/${analysisSel.value}/Contours-Hists/`;
  const analysisFolder2D = `plots/${analysisSel.value}/2Dhists/`;
  let filename = "";
  let filename2d = "";

  if (cond === referenceLabel) {
    filename = `ref-${evt}.png`;
    filename2d = "xG-ref.png";
  } else {
    const val = valSel.value;
    filename = `${cond}-${val}-${evt}.png`;
    filename2d = `${cond}-${val}.png`;
  }

  const analysisFiles = fileMap[analysisSel.value];
  img.src = analysisFiles.includes(filename) ? `${analysisFolder}${filename}` : "";
  img2d.src = filename2d ? `${analysisFolder2D}${filename2d}` : "";
  imgCond.src = `plots/${analysisSel.value}/${analysisSel.value}-cond.png` ;
}


function updateAnalysisDescription() {
  const descElem = document.getElementById("analysis-description");
  const selected = analysisSel.value;
  descElem.innerHTML = analysisDescriptions[selected] || "";
}


/* ---- Event listeners ---- */
analysisSel.addEventListener("change", updateConditionDropdown);
analysisSel.addEventListener("change", updateAnalysisDescription);
condSel.addEventListener("change", updateValueDropdown);
valSel.addEventListener("change", updateEventDropdown);
evtSel.addEventListener("change", updateImages);

/* ---- Download buttons ---- */
downloadBtn.addEventListener("click", () => {
  if (!img.src) return;
  const link = document.createElement("a");
  link.href = img.src;
  link.download = img.src.split("/").pop();
  link.click();
});

download2dBtn.addEventListener("click", () => {
  if (!img2d.src) return;
  const link = document.createElement("a");
  link.href = img2d.src;
  link.download = img2d.src.split("/").pop();
  link.click();
});

downloadCondBtn.addEventListener("click", () => {
  if (!imgCond.src) return;
  const link = document.createElement("a");
  link.href = imgCond.src;
  link.download = imgCond.src.split("/").pop();
  link.click();
});

/* ---- Toggle visibility buttons ---- */
toggleContoursBtn.addEventListener("click", () => {
  contoursContainer.style.display = contoursContainer.style.display === "none" ? "block" : "none";
});

toggle2dBtn.addEventListener("click", () => {
  hist2dContainer.style.display = hist2dContainer.style.display === "none" ? "block" : "none";
});

toggleCondBtn.addEventListener("click", () => {
  condContainer.style.display = condContainer.style.display === "none" ? "block" : "none";
});
</script>

</body>
</html>
